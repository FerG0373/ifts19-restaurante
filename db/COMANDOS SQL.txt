CREATE TABLE personal (
    id INT AUTO_INCREMENT,
    dni VARCHAR(20) NOT NULL,
    nombre VARCHAR(100) NOT NULL,
    apellido VARCHAR(100) NOT NULL,
    email VARCHAR(100) NOT NULL,
    telefono VARCHAR(20),
    fecha_nacimiento DATE,
    sexo ENUM('m', 'f', 'x') NOT NULL,
    puesto ENUM('encargado', 'cocinero', 'mozo', 'cajero', 'bartender') NOT NULL,
    fecha_contratacion DATE NOT NULL,
    
    CONSTRAINT pk__personal__id PRIMARY KEY (id),
    CONSTRAINT uq__personal__dni UNIQUE (dni),
    CONSTRAINT uq__personal__email UNIQUE (email)
);


CREATE TABLE usuario (
    id INT NOT NULL,
    perfil_acceso ENUM('admin', 'encargado', 'mozo') NOT NULL,
    pass_hash VARCHAR(255) NOT NULL,
    activo BOOLEAN DEFAULT TRUE,
    
    CONSTRAINT pk__usuario__id PRIMARY KEY (id),
    CONSTRAINT fk__usuario__id__personal__id 
        FOREIGN KEY (id) REFERENCES personal (id) 
        ON DELETE CASCADE
);


CREATE TABLE mesa (
    id INT AUTO_INCREMENT,
    numero_mesa VARCHAR(20) NOT NULL,
    capacidad INT NOT NULL,
    ubicacion ENUM('salon', 'barra', 'exterior') NOT NULL,
    estado_mesa ENUM('libre', 'ocupada', 'reservada', 'inhabilitada') DEFAULT 'libre',
    activo BOOLEAN DEFAULT TRUE,
    
    CONSTRAINT pk__mesa__id PRIMARY KEY (id),
    CONSTRAINT uq__mesa__numero_mesa UNIQUE (numero_mesa)
);


CREATE TABLE reserva (
    id INT AUTO_INCREMENT,
    mesa_id INT NULL,
    nombre_cliente VARCHAR(100) NOT NULL,
    telefono_cliente VARCHAR(20),
    fecha_reserva DATETIME NOT NULL,
    cantidad_personas INT NOT NULL,
    estado_reserva ENUM('confirmada', 'finalizada', 'cancelada') DEFAULT 'confirmada' NOT NULL,
    
    CONSTRAINT pk__reserva__id PRIMARY KEY (id),
    CONSTRAINT fk__reserva__mesa__id 
        FOREIGN KEY (mesa_id) REFERENCES mesa (id) 
        ON DELETE SET NULL
);


CREATE TABLE asignacion_mesa (
	id INT AUTO_INCREMENT,
    mesa_id INT NOT NULL,
    personal_id INT NOT NULL,
    hora_inicio DATETIME NOT NULL,
    hora_fin DATETIME NULL,
    
    CONSTRAINT pk__asignacion_mesa__id PRIMARY KEY (id),
    CONSTRAINT fk__asignacion_mesa_id
		FOREIGN KEY (mesa_id) REFERENCES mesa (id)
        ON DELETE CASCADE,
	CONSTRAINT fk__asignacion_mesa__personal_id
		FOREIGN KEY (personal_id) REFERENCES personal (id)
        ON DELETE CASCADE
);


CREATE TABLE producto (
    id INT AUTO_INCREMENT,
    nombre VARCHAR(100) NOT NULL,
    descripcion VARCHAR(255),
    precio DECIMAL(10,2) NOT NULL,
    cantidad_stock INT NOT NULL,
    categoria ENUM('entrada', 'principal', 'guarnicion', 'bebida', 'postre') NOT NULL,
    activo BOOLEAN DEFAULT TRUE,
    
    CONSTRAINT pk__producto__id PRIMARY KEY (id),
    CONSTRAINT uq__producto__nombre UNIQUE (nombre)
);


CREATE TABLE pedido (
    id INT AUTO_INCREMENT,
    mesa_id INT NOT NULL,
    personal_id INT NOT NULL,
    fecha_hora DATETIME DEFAULT CURRENT_TIMESTAMP,
    tipo_pedido ENUM('mesa', 'domicilio', 'llevar') DEFAULT 'mesa',
    estado_pedido ENUM('pendiente', 'preparacion', 'listo', 'entregado', 'cancelado') DEFAULT 'pendiente',
    total DECIMAL(10,2) DEFAULT 0.00,
    observaciones VARCHAR(255),
    creacion_registro DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT pk__pedido__id PRIMARY KEY (id),
    CONSTRAINT fk__pedido__mesa_id 
        FOREIGN KEY (mesa_id) REFERENCES mesa (id)
        ON DELETE CASCADE,
    CONSTRAINT fk__pedido__personal_id
        FOREIGN KEY (personal_id) REFERENCES personal (id) 
        ON DELETE CASCADE
);


CREATE TABLE detalle_pedido (
    id INT AUTO_INCREMENT,
    pedido_id INT NOT NULL,
    producto_id INT NOT NULL,
    cantidad INT NOT NULL,
    precio_unitario DECIMAL(10,2) NOT NULL,
    instrucciones_preparacion VARCHAR(255),
    
    CONSTRAINT pk__detalle_pedido__id PRIMARY KEY (id),
    CONSTRAINT fk__detalle_pedido__pedido_id 
        FOREIGN KEY (pedido_id) REFERENCES pedido (id) 
        ON DELETE CASCADE,
    CONSTRAINT fk__detalle_pedido__producto_id 
        FOREIGN KEY (producto_id) REFERENCES producto (id) 
        ON DELETE CASCADE
);


CREATE TABLE factura (
    id INT AUTO_INCREMENT,
    pedido_id INT NOT NULL,
    fecha_emision DATETIME DEFAULT CURRENT_TIMESTAMP,
    subtotal DECIMAL(10,2) NOT NULL,
    impuestos DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    total DECIMAL(10,2) NOT NULL,
    metodo_pago ENUM('efectivo', 'tarjeta_debito', 'tarjeta_credito', 'transferencia', 'mercado_pago') NOT NULL,
    estado ENUM('pendiente', 'pagada', 'cancelada') DEFAULT 'pendiente',
    
    CONSTRAINT pk__factura__id PRIMARY KEY (id),
    CONSTRAINT uq_factura_pedido_id UNIQUE (pedido_id),
    CONSTRAINT fk__factura__pedido_id 
        FOREIGN KEY (pedido_id) REFERENCES pedido (id)
        ON DELETE CASCADE    
);