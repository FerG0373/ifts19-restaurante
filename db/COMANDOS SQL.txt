CREATE TABLE cliente (
	id INT PRIMARY KEY AUTO_INCREMENT,
	persona_id INT NOT NULL,
	nro_cliente VARCHAR(20),
	
	CONSTRAINT uq_cliente_persona_id UNIQUE (persona_id),
	CONSTRAINT uq_cliente_nro_cliente UNIQUE (nro_cliente)
);


CREATE TABLE persona (
    id INT PRIMARY KEY AUTO_INCREMENT,
    dni VARCHAR(15) NOT NULL,
    nombre VARCHAR(50) NOT NULL,
    apellido VARCHAR(50) NOT NULL,
    telefono VARCHAR(20) NULL,
    email VARCHAR(50) NOT NULL,
    fecha_nacimiento DATE NULL,
    creacion_registro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    sexo ENUM('M', 'F', 'Sin especificar') NULL,
    url_foto_perfil VARCHAR(255) NULL,
    
    CONSTRAINT uq_persona_dni UNIQUE (dni),
    CONSTRAINT uq_persona_email UNIQUE (email)
);


CREATE TABLE empleado (
	id INT PRIMARY KEY AUTO_INCREMENT,
	persona_id INT NOT NULL,
	nro_empleado VARCHAR(20) NOT NULL,
	puesto_id INT NOT NULL,
	activo BOOLEAN DEFAULT TRUE,
	
	CONSTRAINT uq_empleado_persona_id UNIQUE (persona_id),
	CONSTRAINT uq_empleado_nro_empleado UNIQUE (nro_empleado)
);


CREATE TABLE puesto (
	id INT PRIMARY KEY AUTO_INCREMENT,
	nombre VARCHAR(20) NOT NULL,
	descripcion VARCHAR(255) NULL,
	
	CONSTRAINT uq_puesto_nombre UNIQUE (nombre)
);


CREATE TABLE registro_asistencia (
	id INT PRIMARY KEY AUTO_INCREMENT,
	empleado_id INT NOT NULL,
	fecha DATE NOT NULL,
	hora_ingreso TIME NOT NULL,
	hora_salida TIME NULL,
	observaciones VARCHAR(255) NULL,
	
	CONSTRAINT uq_asistencia_empleado_fecha UNIQUE (fecha, empleado_id)
);


CREATE TABLE usuario (
	id INT PRIMARY KEY AUTO_INCREMENT,
	empleado_id INT NOT NULL,
	perfil_acceso_id INT NOT NULL,
	pass_hash VARCHAR(100) NOT NULL,
	activo BOOLEAN DEFAULT TRUE
	
	CONSTRAINT uq_usuario_empleado_id UNIQUE (empleado_id)
);


CREATE TABLE perfil_acceso (
	id INT PRIMARY KEY AUTO_INCREMENT,
	descripcion VARCHAR(20),
	
	CONSTRAINT uq_perfil_acceso_descripcion UNIQUE (descripcion)
);


CREATE TABLE asignacion_mesa (
	id INT PRIMARY KEY AUTO_INCREMENT,
	mesa_id INT NOT NULL,
	empleado_id INT NOT NULL,
	hora_inicio DATETIME NOT NULL,
	hora_fin DATETIME NULL,
);


-- Propósito: Garantizar que una mesa NO pueda estar asignada a dos empleados al mismo tiempo.
DELIMITER //
CREATE TRIGGER verificar_mesa_libre_antes_de_insertar
BEFORE INSERT ON asignacion_mesa
FOR EACH ROW
BEGIN
    IF EXISTS (
        SELECT 1 FROM asignacion_mesa 
        WHERE mesa_id = NEW.mesa_id 
        AND hora_fin IS NULL
    ) THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'La mesa ya está asignada a otro empleado';
    END IF;
END//
DELIMITER ;


CREATE TABLE mesa (
	id INT PRIMARY KEY AUTO_INCREMENT,
	nro_mesa VARCHAR(10) NOT NULL,
	capacidad INT NOT NULL CHECK (capacidad > 0),
	ubicacion ENUM('salon', 'barra', 'exterior') NOT NULL,
	estado_mesa ENUM('libre', 'ocupada', 'reservada', 'inhabilitada') DEFAULT 'libre',
	activo BOOLEAN DEFAULT TRUE,
	
	CONSTRAINT uq_mesa_nro_mesa UNIQUE (nro_mesa)
);


CREATE TABLE pedido (
	id INT PRIMARY KEY AUTO_INCREMENT,
	nro_pedido VARCHAR(20) NOT NULL,
	mesa_id INT NULL,
	empleado_id INT NOT NULL,
	cliente_id INT NULL,
	fecha_hora DATETIME DEFAULT CURRENT_TIMESTAMP,
	tipo_pedido ENUM('local', 'llevar', 'delivery') NOT NULL,
	estado_pedido ENUM('pendiente', 'preparacion', 'listo', 'entregado', 'pagado', 'cancelado') DEFAULT 'pendiente',
	total DECIMAL(10,2) DEFAULT 0.00,
	direccion_entrega TEXT NULL,
    observaciones TEXT NULL,
    creacion_registro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	
	CONSTRAINT uq_pedido_nro_pedido UNIQUE (nro_pedido)
);


CREATE TABLE detalle_pedido (
	id INT PRIMARY KEY AUTO_INCREMENT,
	pedido_id INT NOT NULL,
	producto_id INT NOT NULL,
	cantidad INT NOT NULL CHECK (cantidad > 0),
	precio_unitario DECIMAL(10,2),
	subtotal DECIMAL(10,2) GENERATED ALWAYS AS (cantidad * precio_unitario) STORED,
	notas TEXT
);


CREATE TABLE producto (
	id INT PRIMARY KEY AUTO_INCREMENT,
	nombre VARCHAR(50) NOT NULL,
	descripcion VARCHAR(255) NULL,
	precio DECIMAL(10,2) NOT NULL,
	cantidad_stock INT NOT NULL DEFAULT 0,
	categoria_id INT NOT NULL,
	activo BOOLEAN DEFAULT TRUE,
	
	CONSTRAINT uq_producto_nombre UNIQUE (nombre)
);


CREATE TABLE categoria (
	id INT PRIMARY KEY AUTO_INCREMENT,
	nombre VARCHAR(50) NOT NULL,
	descripcion VARCHAR(255) NULL,
	activo BOOLEAN DEFAULT TRUE,
	
	 CONSTRAINT uq_categoria_nombre UNIQUE (nombre)
);